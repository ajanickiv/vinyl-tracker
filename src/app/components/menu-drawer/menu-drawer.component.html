<div class="drawer-container" [class.open]="isOpen()">
  <!-- Backdrop -->
  <div class="backdrop" (click)="onBackdropClick()"></div>

  <!-- Drawer -->
  <div class="drawer">
    <div class="drawer-header">
      <h2>Menu</h2>
      <button class="close-button" (click)="closeDrawer()">âœ•</button>
    </div>

    <div class="drawer-content">
      <!-- Filters Section -->
      <div class="menu-section">
        <h3>Filters</h3>
        <div class="filters-container">
          <!-- Box Set Toggle -->
          <div class="filter-group">
            <label class="toggle-label">
              <span class="toggle-text">Exclude Box Sets</span>
              <button
                class="toggle-button"
                [class.active]="filterService.filters().excludeBoxSets"
                (click)="toggleExcludeBoxSets()"
              >
                <span class="toggle-track">
                  <span class="toggle-thumb"></span>
                </span>
              </button>
            </label>
          </div>

          <!-- Genre Chips -->
          @if (availableGenres().length > 0) {
            <div class="filter-group">
              <p class="filter-label">Genres</p>
              <div class="chip-container">
                @for (genre of availableGenres(); track genre) {
                  <button
                    class="chip"
                    [class.selected]="isGenreSelected(genre)"
                    (click)="toggleGenre(genre)"
                  >
                    {{ genre }}
                  </button>
                }
              </div>
            </div>
          }

          <!-- Original Decade Chips (from Master Release) -->
          @if (availableOriginalDecades().length > 0) {
            <div class="filter-group">
              <p class="filter-label">Release Decade</p>
              <div class="chip-container">
                @for (decade of availableOriginalDecades(); track decade) {
                  <button
                    class="chip"
                    [class.selected]="isOriginalDecadeSelected(decade)"
                    (click)="toggleOriginalDecade(decade)"
                  >
                    {{ decade }}
                  </button>
                }
              </div>
            </div>
          }

          <!-- Decade Chips (Pressing Year) -->
          @if (availableDecades().length > 0) {
            <div class="filter-group">
              <p class="filter-label">Pressing Decade</p>
              <div class="chip-container">
                @for (decade of availableDecades(); track decade) {
                  <button
                    class="chip"
                    [class.selected]="isDecadeSelected(decade)"
                    (click)="toggleDecade(decade)"
                  >
                    {{ decade }}
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Advanced Section (Collapsible) -->
      <div class="advanced-section">
        <button class="advanced-header" (click)="toggleAdvanced()">
          <h3>Advanced</h3>
          <span class="expand-icon" [class.expanded]="advancedExpanded()">â–¼</span>
        </button>

        <div class="advanced-content" [class.expanded]="advancedExpanded()">
          <div class="advanced-content-inner">
            <!-- Discogs Account Section -->
            <div class="menu-section">
              <h3>Discogs Account</h3>
              <div class="account-info">
                @if (!editingCredentials()) {
                  <p class="account-status">
                    Connected as: <strong>{{ credentialsService.getUsername() }}</strong>
                  </p>
                  <button class="edit-credentials-button" (click)="startEditCredentials()">
                    <span class="button-icon">âœŽ</span>
                    Edit Credentials
                  </button>
                  @if (credentialsMessage()) {
                    <p class="sync-message">{{ credentialsMessage() }}</p>
                  }
                } @else {
                  <div class="credentials-form">
                    <div class="form-group">
                      <label for="edit-username">Username</label>
                      <input
                        type="text"
                        id="edit-username"
                        [ngModel]="editUsername()"
                        (ngModelChange)="editUsername.set($event)"
                        placeholder="Discogs username"
                      />
                    </div>
                    <div class="form-group">
                      <label for="edit-token">Personal Access Token</label>
                      <input
                        [type]="showEditToken() ? 'text' : 'password'"
                        id="edit-token"
                        [ngModel]="editToken()"
                        (ngModelChange)="editToken.set($event)"
                        placeholder="Enter new token"
                      />
                      <label class="show-token-toggle">
                        <input
                          type="checkbox"
                          [checked]="showEditToken()"
                          (change)="toggleShowEditToken()"
                        />
                        <span>Show token</span>
                      </label>
                    </div>
                    @if (credentialsMessage()) {
                      <p class="error-message">{{ credentialsMessage() }}</p>
                    }
                    <div class="form-actions">
                      <button class="save-button" (click)="saveCredentials()">Save</button>
                      <button class="cancel-button" (click)="cancelEditCredentials()">
                        Cancel
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Sync Section -->
            <div class="menu-section">
              <h3>Collection Sync</h3>
              <div class="sync-info">
                <p class="sync-status">
                  Last synced: <strong>{{ getTimeSinceSync() }}</strong>
                </p>
                <button class="resync-button" (click)="resync()" [disabled]="syncing()">
                  <span class="button-icon">â†»</span>
                  {{ syncing() ? 'Syncing...' : 'Re-sync from Discogs' }}
                </button>
                @if (syncMessage()) {
                  <p class="sync-message">{{ syncMessage() }}</p>
                }

                <!-- Master Release Sync Toggle -->
                <div class="master-sync-toggle">
                  <label class="toggle-label">
                    <span class="toggle-text">Fetch original release dates</span>
                    <button
                      class="toggle-button"
                      [class.active]="masterReleaseSyncEnabled()"
                      (click)="toggleMasterReleaseSync()"
                    >
                      <span class="toggle-track">
                        <span class="toggle-thumb"></span>
                      </span>
                    </button>
                  </label>
                  <p class="master-sync-hint">
                    Retrieves original release years from Discogs in the background. Disable for
                    large collections.
                  </p>
                </div>
              </div>
            </div>

            <!-- Export/Import Section -->
            <div class="menu-section">
              <h3>Backup & Restore</h3>
              <div class="export-import-container">
                <p class="export-import-info">Export or import your play counts and history.</p>

                <!-- Export Button -->
                <button class="export-button" (click)="onExport()" [disabled]="exporting()">
                  <span class="button-icon">â¬‡</span>
                  {{ exporting() ? 'Exporting...' : 'Export Play Stats' }}
                </button>

                <!-- Import Mode Toggle -->
                <div class="import-mode-toggle">
                  <label class="toggle-label">
                    <span class="toggle-text">
                      {{ importMode() === 'replace' ? 'Replace' : 'Merge' }}
                    </span>
                    <button
                      class="toggle-button"
                      [class.active]="importMode() === 'merge'"
                      (click)="setImportMode(importMode() === 'replace' ? 'merge' : 'replace')"
                    >
                      <span class="toggle-track">
                        <span class="toggle-thumb"></span>
                      </span>
                    </button>
                  </label>
                  <p class="import-mode-hint">
                    {{
                      importMode() === 'replace'
                        ? 'Overwrites all play data'
                        : 'Adds to existing play counts'
                    }}
                  </p>
                </div>

                <!-- Import Button -->
                <button class="import-button" (click)="onImportClick()" [disabled]="importing()">
                  <span class="button-icon">â¬†</span>
                  {{ importing() ? 'Importing...' : 'Import Play Stats' }}
                </button>

                <!-- Hidden file input -->
                <input
                  type="file"
                  id="import-file-input"
                  accept=".json"
                  style="display: none"
                  (change)="onFileSelected($event)"
                />

                <!-- Status message -->
                @if (importExportMessage()) {
                  <p class="sync-message">{{ importExportMessage() }}</p>
                }
              </div>
            </div>

            <!-- Dev Tools Section (only in dev mode) -->
            @if (isDevMode) {
              <div class="menu-section dev-section">
                <h3>Dev Tools</h3>
                <div class="dev-info">
                  <p class="dev-warning">These options are only visible in development mode.</p>
                  <button class="clear-button" (click)="clearData()" [disabled]="clearing()">
                    <span class="button-icon">ðŸ—‘</span>
                    {{ clearing() ? 'Clearing...' : 'Clear All Data' }}
                  </button>
                </div>
              </div>
            }

            <!-- Version -->
            <p class="version-info">Version {{ appVersion }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
