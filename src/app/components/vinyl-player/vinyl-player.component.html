<div class="vinyl-player-container">
  <div class="player-header">
    <button class="search-button" (click)="toggleSearch()">
      <span class="search-icon">&#x1F50D;</span>
    </button>
    <button class="history-button" (click)="toggleHistory()">
      <span class="history-icon">&#x1F553;</span>
    </button>
    <button class="stats-button" (click)="toggleStats()">
      <span class="stats-icon">&#x1F4CA;</span>
    </button>
    <button class="achievements-button" (click)="toggleAchievements()">
      <span class="achievements-icon">&#x1F3C6;</span>
    </button>
    <button class="menu-button" (click)="toggleMenu()">
      <span class="menu-icon">⋮</span>
    </button>
  </div>

  <app-menu-drawer
    [isOpen]="menuOpen()"
    (close)="closeMenu()"
    (dataCleared)="onDataCleared()"
    (filtersChanged)="onFiltersChanged()"
  ></app-menu-drawer>

  <app-search-sheet
    [isOpen]="searchOpen()"
    (close)="closeSearch()"
    (releaseSelected)="onReleaseSelected($event)"
  ></app-search-sheet>

  <app-play-history-sheet
    [isOpen]="historyOpen()"
    (close)="closeHistory()"
    (releaseSelected)="onHistoryReleaseSelected($event)"
  ></app-play-history-sheet>

  <app-stats-sheet
    [isOpen]="statsOpen()"
    (close)="closeStats()"
    (filterApplied)="onFiltersChanged()"
    (releaseSelected)="onReleaseSelected($event)"
  ></app-stats-sheet>

  <app-achievements-sheet
    [isOpen]="achievementsOpen()"
    (close)="closeAchievements()"
  ></app-achievements-sheet>

  @if (isLoading()) {
    <div class="loading">
      <p>Loading recommendation...</p>
    </div>
  } @else if (currentRelease()) {
    <div class="player">
      <!-- Vinyl Record Player -->
      <div class="turntable-wrapper">
        <div class="turntable-base">
          <!-- Record -->
          <div class="record">
            <!-- Vinyl disc background -->
            <div class="vinyl-disc"></div>

            <!-- Grooves effect -->
            <div class="grooves">
              @for (groove of [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]; track groove) {
                <div class="groove" [style.inset.%]="groove * 8"></div>
              }
            </div>

            <!-- Album Art - spins on play -->
            <div class="album-art" [class.spinning]="isSpinning()">
              <img
                [src]="currentRelease()!.basicInfo.coverImage || currentRelease()!.basicInfo.thumb"
                [alt]="currentRelease()!.basicInfo.title"
              />
              <div class="vinyl-texture"></div>
            </div>

            <!-- Center label -->
            <div class="center-label">
              <div class="center-hole"></div>
            </div>
          </div>

          <!-- Tonearm/Stylus -->
          <div class="tonearm" [class.playing]="isSpinning()">
            <div class="arm"></div>
            <div class="headshell"></div>
            <div class="pivot"></div>
          </div>
        </div>
      </div>

      <!-- Album Info -->
      <div class="album-info">
        <h2 class="artist">{{ currentRelease()!.basicInfo.artists | artistName }}</h2>
        <h3 class="title">{{ currentRelease()!.basicInfo.title }}</h3>
        <p class="meta">
          @if (
            currentRelease()!.basicInfo.originalYear &&
            currentRelease()!.basicInfo.year &&
            currentRelease()!.basicInfo.originalYear !== currentRelease()!.basicInfo.year
          ) {
            {{ currentRelease()!.basicInfo.originalYear }} ({{ currentRelease()!.basicInfo.year }}
            pressing)
          } @else if (currentRelease()!.basicInfo.originalYear) {
            {{ currentRelease()!.basicInfo.originalYear }}
          } @else if (currentRelease()!.basicInfo.year) {
            {{ currentRelease()!.basicInfo.year }}
          } @else {
            Unknown year
          }
          • {{ getFormatString(currentRelease()!) }}
        </p>
      </div>

      <!-- Stats -->
      <div class="stats">
        <div class="stat">
          <div class="stat-value">{{ currentRelease()!.playCount }}</div>
          <div class="stat-label">Plays</div>
        </div>
        <div class="stat">
          <div class="stat-value">{{ getFormattedDate(currentRelease()!.lastPlayedDate) }}</div>
          <div class="stat-label">Last Played</div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="actions">
        <button class="btn-primary" (click)="markAsPlayed()" [disabled]="isSpinning()">
          <span class="btn-icon">▶</span>
          {{ isSpinning() ? 'Playing...' : 'Mark as Played' }}
        </button>

        <button class="btn-secondary" (click)="skipToNext()" [disabled]="isSpinning()">
          <span class="btn-icon">⏭</span>
          Skip / Get Another
        </button>
      </div>

      <!-- Master Release Fetch Progress -->
      @if (masterFetchInProgress()) {
        <div class="master-fetch-progress">
          <span class="progress-text">Fetching release dates...</span>
          <span class="progress-count"
            >{{ masterFetchProgress().total - masterFetchProgress().completed }} remaining</span
          >
        </div>
      }
    </div>
  } @else {
    <div class="empty-state">
      <p>No releases found in your collection.</p>
      <p>Please sync your Discogs collection first.</p>
    </div>
  }

  @if (pendingToast()) {
    <app-achievement-toast [badge]="pendingToast()!" (dismiss)="dismissToast()">
    </app-achievement-toast>
  }
</div>
